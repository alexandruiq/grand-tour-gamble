# The Grand Tour Gamble â€” Negotiation Flow & Multiplier Logic (Updated)

## ğŸ” When Negotiation Happens
Negotiation takes place **three times** during the 10-stage game:
- **Before Stage 4**
- **Before Stage 7**
- **Before Stage 9**

These stages will have **special multiplier logic** applied.

---

## ğŸ“£ New Component: `MultiplierBanner.tsx`
A persistent UI banner visible in `/game`, showing:
- Current **stage multiplier** (default: `x1.0`)
- A badge for **"Negotiation Stage Active"** when `is_negotiation = true`

This component pulls data from the current stage in Supabase:
- `stages.multiplier`
- `stages.is_negotiation`

---

## ğŸ—‚ Supabase Schema Changes (stages table)

| Column          | Type    | Description                                 |
|-----------------|---------|---------------------------------------------|
| multiplier       | FLOAT   | Default 1.0, set to 1.5 or 2.0 after negotiation |
| is_negotiation   | BOOLEAN | Marks stage as negotiation-enabled          |

These values are set in advance, or changed after negotiation resolution by trainer action.

---

## ğŸ§  Negotiation Logic Flow

### 1. Stage starts with `is_negotiation = true`
- The `MultiplierBanner` shows the negotiation is active.
- Players see visual cue but stay in `/game`, no new page is needed.

### 2. During Negotiation
- Players discuss their approach (Cruise/Sprint)
- Each group clicks a "Ready to Vote" toggle when decided (tracked per cyclist or user group)
- Once all toggles are true or trainer ends voting manually, negotiation ends.

### 3. Edge Function Triggered
Trainer clicks "Finalize Negotiation" â†’ triggers:
- Counts how many groups picked the same action (Cruise/Sprint)
- If:
  - **3 of 4 aligned** â†’ multiplier = `1.5`
  - **4 of 4 aligned** â†’ multiplier = `2.0`
  - **< 3 aligned** â†’ multiplier = `1.0`
- Updates `stages.multiplier` for that session and stage

### 4. Multiplier Applied
- All stage results are calculated using this multiplier
- `decision.points * multiplier` â†’ new score
- Updated in `cyclists.current_points`

---

## âœ… Implementation Checklist

| Task | Status |
|------|--------|
| Add `multiplier` & `is_negotiation` to `stages` table | â¬œï¸ |
| Create `MultiplierBanner.tsx` component | â¬œï¸ |
| Load from Supabase current stageâ€™s multiplier & flag | â¬œï¸ |
| Trigger multiplier update after negotiation ends | â¬œï¸ |
| Modify edge function to update `stages.multiplier` | â¬œï¸ |
| Use `multiplier` in scoring logic engine | â¬œï¸ |

---

This system integrates negotiation logic directly into stage gameplay with minimal UI disruption and accurate backend linkage. Ready for Cursor implementation once checked off.
