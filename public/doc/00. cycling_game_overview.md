
Cycling Game Web App (The Grand Tour Gamble)

You are helping me build a web-based soft-skills training game called **The Grand Tour Gamble** using **Next.js (App Router)** and **Supabase**. The game is based on the Prisoner's Dilemma, where participants each control a cyclist on Team Rubicon.

This app will be accessed by participants during training sessions.

---

### üîß Tech Stack & Requirements:
- **Framework:** Next.js (App Router structure, TypeScript)
- **Auth & DB:** Supabase (email/password + magic link login)
- **Styling:** TailwindCSS (keep components clean and minimal)
- **State Management:** Context API or lightweight hooks
- **No UI libraries like Chakra or MUI** ‚Äì keep it modular and build only what's needed.

---

### üåç Pages & Flow:

1. `/` (Landing/Login Page) - user and admin (2 separate pages)
   - Enter a **Trainer Code**
   - Enter a **Team name**
   - Auth with Supabase (Magic Link or Email Login)
   - Next button to go to the next page after all have been subbmitted

2. `/history`
   - Displays **The Grand Tour Gamble backstory**
   - Introduce **Team Rubicon** and rival teams
   - Next button to go to the next page

3. `/rules`
   - Game objectives: Team vs Individual victory
   - Decision mechanic: **Sprint or Cruise**
   - Stamina, fatigue, negotiation rounds, and point multipliers
   - Stage progression and team synergy penalties
   - No mention of badges (they are currently disabled)
   - Next button to go to the next page

   4. '/game' (Player Dashboard ‚Äî Cyclist View)
   - Main dashboard for a cyclist (player)
   - See character card (backstory, stats, stamina, fatigue)
   - Stage view: map + current event description
   - Decision options: Sprint / Cruise (with consequences)
   - Past choices and points earned
   - Team scoreboard, overall standings, negotiation timer
   ‚Ä¢ Session is accessed via unique Cyclist Join Code (linked to session_id, team_name, cyclist_id).
   ‚Ä¢ Authenticated through Supabase.
   ‚Ä¢ Supabase Realtime and Storage used for updates and markdown content.
   STATE CONTROL:
   - Decisions disabled when session.stage_locked = true
   - Reflection stage shows overlay notice (‚ÄúReflection in Progress‚Äù)
   - Negotiation timer visible only on stages 4, 7, 9
   - Multiplier badge always visible but changes only when active
   DATA CONNECTIONS:
   - Supabase tables: decisions_log, users, sessions, teams, cyclists
   - Markdown: cyclist backstories, rules, stages, game history
   - Subscriptions: stage change, synergy, leaderboard updates


5. `/negotiation`
   - Unlocks only during 3 predefined negotiation moments
   - Lobby with chat (basic implementation)
   - Players propose strategies to Cruise or Sprint

6. `/reflection`
   - After each stage, short textbox: ‚ÄúWhy did you make your decision?‚Äù
   - Display other riders' decisions and outcomes

7. `/debrief`
   - Final reflection and team/individual debrief
   - Breakdown of choices made across all 10 stages

8. `/trainer/dashboard`
   - Admin panel (protected via Supabase roles)
   - See all teams, cyclists, decisions, and scores
   - Reset session / start new training
   - Main dashboard for the **trainer (admin)**
   - View **session controls**: Start Stage, End Stage, Lock/Unlock Decisions
   - See **current stage** and global game status (Active, In Reflection, Ended)
   - Live **Team Rubicon scoreboard** (points, synergy, fatigue, decisions summary)
   - View **Individual Cyclist Data**:
     - Names, stamina, decision history, total points
     - Backstory preview modal for quick reference
   - Manage **rival team logic status**:
     - Display AI decisions per team per stage
     - Show AI scores (Solaris, Corex, Vortex)
   - Control **negotiation rounds**:
     - Toggle open/closed
     - Set current multiplier (x1.5, x2.0)
     - See which teams are aligned
   - Trigger **reflection period**
     - Locks player inputs
     - Displays timer component only (no decisions)
   - Export **Debrief Summary Report**:
     - Per cyclist: choices, scores, patterns
     - Team performance graph
   - Developer-only tab (optional):
     - Force override of stage, state, or logic (testing mode)

UI Components needed:
- `StageControlPanel.tsx`
- `TeamScoreboard.tsx`
- `CyclistStatsTable.tsx`
- `AIMoveTracker.tsx`
- `NegotiationControl.tsx`
- `ReflectionManager.tsx`
- `DebriefExporter.tsx`
- `TrainerLayout.tsx` (wrapping layout)


9. "/admin" ‚Üí Session Creation Page
   ‚Üí Creates session
   ‚Üí Gets session code + sessionId

   Where a trainer creates a new session (the setup phase)

Actions:
	‚Ä¢	Enter game name / label
	‚Ä¢	Generate session code (randomized 6-character alphanumeric)
	‚Ä¢	Set total number of teams or cyclists
	‚Ä¢	Optional: Upload logo or banner
	‚Ä¢	Button: Create Session
	‚Ä¢	Upon creation ‚Üí redirect to /trainer/{sessionId}

Purpose:
	‚Ä¢	Think of this like a ‚Äúlobby builder‚Äù
	‚Ä¢	One-time access per session setup
	‚Ä¢	Clean and minimal UI
	‚Ä¢	Writes new entry to sessions table

---

### üß© Core Components (Keep atomic & lean):

- `CyclistCard.tsx`: Displays backstory, stats, current status
- `DecisionButtons.tsx`: Sprint / Cruise toggle + cost summary
- `StageMap.tsx`: Lightweight visual of the 10 stages + highlights current one
- `StaminaBar.tsx`: Current stamina, fatigue, penalties
- `TeamScoreboard.tsx`: Live team stats and standings
- `ReflectionModal.tsx`: Used after each stage
- `NegotiationChat.tsx`: Temporary chatbox for strategic discussions

---

### üîê Auth Model:
- Supabase handles login via code + magic link
- Store session token locally
- Each user has:
  - `name`
  - `cyclist_id`
  - `team_id`
  - `trainer_code`
  - `role` (user or trainer)

---

### üß† Data Structure (Postgres via Supabase):

- `cyclists` (id, name, backstory, stats, team_id)
- `teams` (id, name, points, fatigue, synergy)
- `stages` (id, name, description, type, multiplier_active)
- `decisions` (user_id, stage_id, choice, result, timestamp)
- `reflections` (user_id, stage_id, message)
- `negotiations` (trainer_code, stage_id, is_open)

---

### üì¶ Dependencies to install:

npm install @supabase/supabase-js tailwindcss postcss autoprefixer classnames

üéØ Guidelines:
‚Ä¢ No UI bloat: keep components simple, testable, and isolated
‚Ä¢ Reuse layouts, don‚Äôt duplicate logic
‚Ä¢ Favor hooks for stage logic and Supabase queries
‚Ä¢ Prioritize performance ‚Äì reduce unnecessary re-renders
‚Ä¢ Mobile-first responsive design

---

üìò MARKDOWN INTEGRATION

The app uses the .md files located in public to present rich game content in-app (no hardcoded text in components)

Each page where these are needed should read and render them via MDX or Markdown parser.

---

