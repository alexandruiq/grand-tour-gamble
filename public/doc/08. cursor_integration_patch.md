# The Grand Tour Gamble â€” Final Integration Patch (Cursor-Ready)

This document includes **all the missing elements**, **clarified logic**, and **recommended files/components** needed to bring the implementation to 95% readiness before you begin development in Cursor.

---

## âœ… MUST-HAVE ADDITIONS

### 1. ğŸ§® Edge Function: `calculateScoresForStage()`

#### Purpose:
Centralize all scoring logic, update Supabase records, and control game state transition.

#### Triggered by:
Trainer clicks "End Stage" in the dashboard.

#### Input:
- `session_id`
- (Optional) `stage_number` (default: current stage from `sessions` table)

#### Logic:
- Fetch all player decisions for that stage from `decisions_log`
- Fetch current cyclist stamina + synergy score from `cyclists` & `teams`
- Apply **Scoring Matrix**, **Stamina**, **Burnout**, **Synergy Gain**, **Multipliers**, and **AI decisions**
- Update:
  - `cyclists.current_points`
  - `cyclists.stamina`
  - `cyclists.fatigue_penalty`
  - `teams.total_points`
  - `teams.synergy_score`
  - Log all AI decisions to `decisions_log`
  - Write result summary to new `stage_summaries` table

#### Output:
- JSON result of all point changes and state updates (for UI)

---

### 2. ğŸ¤– AI Decision Logic (Deterministic)

#### Define per team:
```ts
const AI_PROFILES = {
  solaris: ["cruise", "cruise", "cruise", "sprint"], // 3/4 cruise
  corex:    ["cruise", "sprint", "cruise", "sprint"], // 2/2 split
  vortex:   ["sprint", "sprint", "sprint", "cruise"],  // 3/4 sprint
};
```

#### Storage:
- Generate 4 AI cyclists per rival team in `cyclists` table
- Log their decisions to `decisions_log` like any player

---

### 3. ğŸ—‚ï¸ New Supabase Table: `stage_summaries`

| Column             | Type      | Description                                      |
|--------------------|-----------|--------------------------------------------------|
| id                 | UUID      | PK                                               |
| session_id         | UUID      | FK to sessions                                   |
| stage_number       | Integer   | Stage index                                      |
| synergy_delta      | Integer   | Net change in synergy for Team Rubicon          |
| player_snapshot    | JSONB     | All player decisions + stamina before/after     |
| ai_snapshot        | JSONB     | All AI decisions                                 |
| scoring_outcomes   | JSONB     | Points gained/lost per cyclist/team             |
| multiplier_used    | Float     | Stage multiplier (if any)                        |
| created_at         | Timestamp |                                                  |

---

### 4. ğŸ§¾ Supabase Schema Updates

#### `sessions` table
```ts
+ current_stage: integer
+ stage_state: enum("locked", "open", "reflection")
```

#### `decisions_log` table
```ts
+ decision_source: enum("player", "ai")
```

---

## ğŸ›ï¸ Frontend Control Flow Components (Trainer View)

### âœ… StageController.tsx
Trainer sees controls for:
- [ ] Open Decision Window
- [ ] Lock Decision Window
- [ ] Run Score Calculation (calls edge function)
- [ ] Advance to Next Stage
- [ ] Toggle Reflection Screen

Stage state transitions:
- `locked` â†’ `open` â†’ `locked` â†’ `reflection` â†’ `locked`

---

## ğŸ“Š Debugging + Reset Tools

### `/debug/[sessionId]`
- Trainer-only page
- Show all 16 cyclist decisions (per stage)
- Manual override of decisions (for dev/testing)
- Rerun scoring engine

---

## ğŸ” Auth Middleware: Role Guard

Middleware to enforce routes:
```ts
withRoleGuard("player") // for player routes
withRoleGuard("trainer") // for dashboard, debug, admin
```

---

## ğŸ’¬ Optional Enhancement: Reflection UI

- After scoring, show a Stage Recap component:
  - Summary of player + AI decisions
  - Who gained/lost points
  - Synergy change
- Label the phase: "Reflection Round â€” Discuss with your team."
- Countdown timer (optional)
- No input required

---

## ğŸ“˜ Markdown Content Missing

Create new file:
- `cyclist-backstories.md`

Format:
```md
## Luca Moretti
The Italian tactician... (short bio)

## Jonas Leclerc
The loyal domestique... (short bio)

## Mateo Silva
The wildcard sprinter... (short bio)

## Kenji Yamamoto
The strategist from Japan... (short bio)
```

---

## âœ… Cursor-Ready Summary Checklist

| Area                        | Status           |
|-----------------------------|------------------|
| Scoring Engine              | âœ… Defined        |
| AI Team Behavior            | âœ… Deterministic  |
| Reflection Logic            | âœ… Visual Flow    |
| Supabase Schema             | âœ… Updated        |
| Edge Function Spec          | âœ… Done           |
| Role-Based Routing          | âœ… Middleware     |
| Debug Tools                 | âœ… Suggested      |
| Stage Control Flow          | âœ… Fully Defined  |
| Markdown Assets             | âœ… Backstories    |

Once all this is implemented or passed to Cursor, youâ€™re **95% ready to start dev without risk of breaking core logic or state flow**.

Let me know if you'd like the full TypeScript types or schema.sql exported from this.
