# üß© Game Session Status Lifecycle (Supabase)

## Goal:
Track the lifecycle of each game session with a `status` field in the `sessions` table, used to determine if the session is in progress, completed, or pending.

## Supabase Table Update:
Add the following field to the `sessions` table:
```ts
status: "waiting" | "active" | "completed"
```

## Lifecycle Flow:
1. When a session is first created (in `/admin`), set `status = "waiting"`.
2. When the trainer starts Stage 1, set `status = "active"`.
3. When the trainer ends **Stage 10**, set `status = "completed"`.

## Supabase Logic:
This change is triggered by the `calculateStageResults` edge function:
```ts
// If current_stage === 10
await supabase
  .from('sessions')
  .update({ status: 'completed' })
  .eq('id', sessionId);
```

## Why This Matters:
This enables conditional rendering, UI routing (to `/debrief`), and state control throughout the app.

---

# üîÅ Debrief Redirect Logic

## Goal:
Redirect players and trainers to the appropriate debrief pages after the final stage of the game.

## Logic Overview:
This logic is used after Stage 10 is completed and `status = "completed"` in the Supabase `sessions` table.

## In `/game` Route:
```ts
// Inside useEffect or game loader
if (session.status === 'completed') {
  router.push('/debrief');
}
```

## In `/trainer` Route:
```ts
// Inside useEffect or trainer session loader
if (session.status === 'completed') {
  router.push('/trainer/debrief');
}
```

## Best Practices:
- Load `status` from Supabase on mount or via session context.
- Ensure `status` checks are reactive (use subscription or polling).
- Only redirect once status is confirmed as `"completed"` to avoid premature routing.

---

# üß± Debrief Components

## Goal:
Build two separate debrief components:
1. `PlayerDebrief.tsx` ‚Äì A solo summary of each cyclist's journey
2. `TrainerDebrief.tsx` ‚Äì A full group debrief view for the trainer

---

## Component 1: PlayerDebrief.tsx

**Location:** `/components/player/PlayerDebrief.tsx`

### Content:
- Cyclist name and image
- Final score and rank
- Synergy contribution (positive/negative)
- Stamina usage timeline
- Highlighted decisions (when did they sprint? cruise?)
- Small badge showing "Solo-focused" vs. "Team-focused" behavior
- Motivational message or quote

### Data:
Pull from:
- `cyclists` table (bio, name, image)
- `decisions_log` (decision history)
- `sessions` table (team score)

---

## Component 2: TrainerDebrief.tsx

**Location:** `/components/trainer/TrainerDebrief.tsx`

### Content:
- Final team standings (Rubicon vs. rivals)
- Cyclist leaderboard
- Decision heatmap: % sprints vs. cruises per player
- Team synergy evolution (line or bar chart)
- Fatigue chart (average stamina used)
- Coaching notes / group discussion prompts

### Data:
Aggregate from:
- `cyclists`
- `decisions_log`
- `teams`
- `sessions`

---

## UI Guidelines:
- Use card layout for each cyclist summary
- Debrief can be paginated or scrollable
- Consider tabs: "Team Summary", "Individual Stats", "Insights"

