
# Edge Function Spec â€” calculateStageResults_spec.txt

This edge function calculates stage results at the end of each stage, based on decisions submitted by cyclists and the behavior logic of the AI teams.

---

## âœ… Trigger
Triggered when trainer clicks **"End Stage"** in the dashboard.

---

## ðŸ“¥ Input

- **session_id** (string): the current session identifier
- **stage_number** (int): the current stage number
- Supabase fetch:
  - All 4 cyclist decisions from `decisions_log` where session_id and stage match
  - Current cyclist stamina levels from `cyclists` table
  - Current team synergy from `teams` table
  - AI team profiles from static config

---

## ðŸ§  Logic

1. **Parse Cyclist Decisions**
   - Count Sprints and Cruises.
   - Validate if all players submitted.

2. **Apply Matrix**
   - Use scoring matrix to assign points to each cyclist
   - Adjust based on group alignment
   - Deduct 2 points for sprints with 0 stamina (burnout)

3. **Update Stamina**
   - -1 for Sprint
   - +1 for Cruise (only if synergy >= 50)
   - Cap at 5 stamina, min at 0

4. **Calculate Synergy Change**
   - Based on matrix synergy logic:
     - 4X = +20
     - 3X/1Y = +10
     - 2X/2Y = 0
     - 1X/3Y = -10
     - 4Y = -20

5. **Handle Zero Stamina**
   - Sprinting with 0 stamina = not allowed (frontend validation)
   - Frontend enforces cruise-only selection when stamina = 0

6. **Negotiate Multiplier**
   - If stage is 4, 7, or 9:
     - Check if 3 or 4 cyclists aligned
     - Apply x1.5 or x2 multiplier to next stage score

7. **AI Team Decisions**
   - Fixed % behavior (e.g., Solaris 70% Cruise)
   - Generate AI decisions and score them via same matrix
   - Update AI team points

8. **Write Back to Supabase**
   - Update cyclists scores and stamina
   - Update synergy
   - Log AI decisions in decisions_log
   - Update team scores

---

## ðŸ“¤ Output

Returns updated:
- Cyclist scores
- Team scores
- Synergy value
- AI decisions
